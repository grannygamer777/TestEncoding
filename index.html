<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ultra Short Delta Compressor</title>
</head>
<body>
<h2>Ultra Short Delta Compressor</h2>

<!-- Encode Box -->
<h3>Encode Numbers</h3>
<textarea id="inputNums" rows="3" cols="60">0,0,400,400,300,300,200,200,100,100,321,124,222</textarea><br>
<button onclick="doEncode()">Encode</button>
<button onclick="copyCompressed()">Copy Compressed</button>
<p><b>Compressed:</b></p>
<textarea id="compressed" rows="2" cols="60" readonly></textarea>

<hr>

<!-- Decode Box -->
<h3>Decode Compressed String</h3>
<textarea id="inputCompressed" rows="2" cols="60"></textarea><br>
<button onclick="doDecode()">Decode</button>
<button onclick="copyDecoded()">Copy Decoded</button>
<p><b>Decoded Numbers:</b></p>
<textarea id="decoded" rows="3" cols="60" readonly></textarea>

<script>
// --- Alphabet and base ---
const ALPHABET = "!@#$%^&*()_+?><:|~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
const BASE = BigInt(ALPHABET.length);

// --- BigInt <-> String ---
function bigIntToString(n) {
  if (n === 0n) return ALPHABET[0];
  let out = "";
  while (n > 0n) {
    let rem = Number(n % BASE);
    out = ALPHABET[rem] + out;
    n = n / BASE;
  }
  return out;
}

function stringToBigInt(str) {
  let n = 0n;
  for (let ch of str) {
    let idx = ALPHABET.indexOf(ch);
    if (idx < 0) throw new Error("Invalid character: " + ch);
    n = n * BASE + BigInt(idx);
  }
  return n;
}

// --- Encode ---
function encodeList(nums) {
  if (nums.length === 0) return "";

  // deltas
  let deltas = [nums[0]];
  for (let i = 1; i < nums.length; i++) {
    deltas.push(nums[i] - nums[i - 1]);
  }

  // shift +400 to keep >=0
  let shifted = deltas.map(d => d + 400);

  // pack into BigInt (base-801)
  let value = 0n;
  for (let s of shifted) {
    value = value * 801n + BigInt(s);
  }

  let compressed = bigIntToString(value);
  let lenPart = bigIntToString(BigInt(nums.length));
  return compressed + "-" + lenPart;
}

// --- Decode ---
function decodeList(code) {
  if (!code.includes("-")) return [];
  let [comp, lenPart] = code.split("-");
  let length = Number(stringToBigInt(lenPart));

  let value = stringToBigInt(comp);
  let shifted = [];
  for (let i = 0; i < length; i++) {
    shifted.unshift(Number(value % 801n));
    value = value / 801n;
  }
  let deltas = shifted.map(s => s - 400);

  // rebuild
  let nums = [];
  if (deltas.length > 0) {
    nums.push(deltas[0]);
    for (let i = 1; i < deltas.length; i++) {
      nums.push(nums[nums.length - 1] + deltas[i]);
    }
  }
  return nums;
}

// --- UI Functions ---
function doEncode() {
  let input = document.getElementById("inputNums").value.split(",").map(x => parseInt(x.trim()));
  let code = encodeList(input);
  document.getElementById("compressed").value = code;
  document.getElementById("inputCompressed").value = code; // auto-fill decode box
}

function doDecode() {
  let code = document.getElementById("inputCompressed").value.trim();
  if (!code) return alert("Paste compressed string first!");
  let nums = decodeList(code);
  document.getElementById("decoded").value = nums.join(",");
}

// --- Copy Buttons ---
function copyCompressed() {
  let box = document.getElementById("compressed");
  box.select();
  document.execCommand("copy");
  alert("Compressed string copied!");
}

function copyDecoded() {
  let box = document.getElementById("decoded");
  box.select();
  document.execCommand("copy");
  alert("Decoded numbers copied!");
}
</script>
</body>
</html>
